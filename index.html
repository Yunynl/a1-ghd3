<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignment 1 - Hello World: GitHub and D3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #f0f2f5;
            font-family: "Segoe UI", sans-serif;
        }

        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 5;
            pointer-events: none;
        }

        #stats-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60px;
            background: rgba(255, 255, 255, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            font-size: 20px;
            font-weight: 700;
            border-top: 2px solid #ddd;
        }

        .timer { color: #d63031; }
        .score { color: #00b894; }

        #start-btn {
            position: absolute;
            top: 50%;
            left: 75%;
            transform: translate(-50%, -50%);
            padding: 15px 40px;
            font-size: 22px;
            background: #0984e3;
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        #summary-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 450px;
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            text-align: center;
            z-index: 100;
        }

        #chart-container {
            margin: 20px 0;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
        }

        .bar-value {
            font-size: 12px;
            fill: white;
            font-weight: 700;
            pointer-events: none;
        }

        .draggable { cursor: grab; }

        #game-zone {
            fill: #ffffff;
            stroke: #dfe6e9;
            stroke-width: 2;
            stroke-dasharray: 8;
        }

        /* HOVER + DRAG FEEDBACK */
        .catcher:hover {
            opacity: 0.92;
            filter: drop-shadow(0 6px 10px rgba(0,0,0,0.18));
            cursor: grab;
        }

        .catcher.dragging {
            opacity: 0.80;
            filter: drop-shadow(0 10px 16px rgba(0,0,0,0.25));
            cursor: grabbing !important;
        }
    </style>
</head>

<body>
<div id="ui-overlay">
    <h1>D3 Data Visualizer Game</h1>
    <p>Drag the catchers and catch the falling shapes.</p>
</div>

<button id="start-btn">Start!</button>

<div id="summary-modal">
    <h2>Performance Summary</h2>
    <div id="chart-container"></div>
    <div id="results-text" style="font-size:16px; margin-bottom:20px;"></div>
    <button id="play-again-btn"
            style="padding: 12px 25px; cursor:pointer; background:#0984e3; color:white; border:none; border-radius:5px;">
        Play Again
    </button>
</div>

<div id="stats-bar">
    <div class="timer">Time: <span id="time-val">15</span>s</div>
    <div class="score">Caught: <span id="score-val">0</span></div>
</div>

<svg id="main-canvas"></svg>

<script>
    const svg = d3.select("#main-canvas");
    const width = window.innerWidth;
    const height = window.innerHeight;

    svg.attr("width", width).attr("height", height);

    const gameXStart = width / 2;

    svg.append("rect")
        .attr("id", "game-zone")
        .attr("x", gameXStart)
        .attr("y", 10)
        .attr("width", (width / 2) - 10)
        .attr("height", height - 80);

    let score = 0;
    let timeLeft = 15;
    let gameActive = false;

    let timerId = null;
    let statsByType = { rect: 0, circle: 0, path: 0 };

    const dragHandler = d3.drag()
        .on("start", function () {
            d3.select(this).raise();
            d3.select(this).classed("dragging", true).style("cursor", "grabbing");
        })
        .on("drag", function (event) {
            d3.select(this).attr("transform", `translate(${event.x}, ${event.y})`);
            this.__pos__ = { x: event.x, y: event.y };
        })
        .on("end", function () {
            d3.select(this).classed("dragging", false).style("cursor", "grab");
        });

    function attachHover(g) {
        g.on("mouseenter", function () {
            if (!d3.select(this).classed("dragging")) {
                d3.select(this).style("cursor", "grab");
            }
        })
            .on("mouseleave", function () {
                if (!d3.select(this).classed("dragging")) {
                    d3.select(this).style("cursor", "default");
                }
            });
    }

    function addCatcher(x, y, drawFn) {
        const g = svg.append("g")
            .attr("class", "draggable catcher")
            .attr("transform", `translate(${x}, ${y})`);

        g.node().__pos__ = { x, y };

        drawFn(g);

        attachHover(g);
        g.call(dragHandler);
    }

    addCatcher(100, 100, g => {
        g.append("rect")
            .attr("width", 80)
            .attr("height", 60)
            .attr("fill", "#0984e3");
    });

    addCatcher(250, 150, g => {
        g.append("circle")
            .attr("r", 40)
            .attr("fill", "#e84393");
    });

    addCatcher(150, 350, g => {
        g.append("path")
            .attr("d", "M 0,-40 L 10,-10 L 40,-10 L 15,10 L 25,40 L 0,20 L -25,40 L -15,10 L -40,-10 L -10,-10 Z")
            .attr("fill", "#fdcb6e");
    });

    addCatcher(350, 350, g => {
        g.append("line")
            .attr("x1", 0).attr("y1", 0)
            .attr("x2", 80).attr("y2", 80)
            .attr("stroke", "#6c5ce7")
            .attr("stroke-width", 10)
            .attr("stroke-linecap", "round");

        g.append("line")
            .attr("x1", 0).attr("y1", 0)
            .attr("x2", 80).attr("y2", 80)
            .attr("stroke", "transparent")
            .attr("stroke-width", 30);
    });

    function setScore(val) {
        score = val;
        d3.select("#score-val").text(score);
    }

    function setTime(val) {
        timeLeft = val;
        d3.select("#time-val").text(timeLeft);
    }

    function showStartButton(show) {
        d3.select("#start-btn").style("display", show ? "block" : "none");
    }

    function showSummary(show) {
        d3.select("#summary-modal").style("display", show ? "block" : "none");
    }

    function startGame() {
        gameActive = true;

        setScore(0);
        setTime(15);
        statsByType = { rect: 0, circle: 0, path: 0 };

        showStartButton(false);
        showSummary(false);

        if (timerId) clearInterval(timerId);
        timerId = setInterval(() => {
            setTime(timeLeft - 1);
            if (timeLeft <= 0) endGame();
        }, 1000);

        spawnLoop();
    }

    function endGame() {
        gameActive = false;
        if (timerId) clearInterval(timerId);

        showSummary(true);
        drawSummaryChart();
    }

    function spawnLoop() {
        if (!gameActive) return;
        spawnItem();
        setTimeout(spawnLoop, 600);
    }

    function spawnItem() {
        const types = ["rect", "circle", "path"];
        const type = types[Math.floor(Math.random() * types.length)];

        const xPos = gameXStart + 50 + Math.random() * (width / 2 - 150);

        const item = svg.append("g")
            .attr("transform", `translate(${xPos}, -50)`);

        if (type === "rect") {
            item.append("rect").attr("width", 30).attr("height", 30).attr("fill", "#2d3436");
        } else if (type === "circle") {
            item.append("circle").attr("r", 15).attr("fill", "#2d3436");
        } else {
            item.append("path")
                .attr("d", "M 0,-15 L 4,-4 L 15,-4 L 6,4 L 9,15 L 0,8 L -9,15 L -6,4 L -15,-4 L -4,-4 Z")
                .attr("fill", "#2d3436");
        }

        const node = item.node();
        node.__caught__ = false;

        item.transition()
            .duration(2500)
            .ease(d3.easeLinear)
            .attr("transform", `translate(${xPos}, ${height + 50})`)
            .on("end", function () { d3.select(this).remove(); })
            .tween("collisionCheck", function () {
                return function () {
                    if (node.__caught__) return;

                    const iBox = node.getBoundingClientRect();

                    d3.selectAll(".catcher").each(function () {
                        if (node.__caught__) return;

                        const cBox = this.getBoundingClientRect();
                        const overlap =
                            !(iBox.right < cBox.left ||
                                iBox.left > cBox.right ||
                                iBox.bottom < cBox.top ||
                                iBox.top > cBox.bottom);

                        if (overlap) {
                            node.__caught__ = true;
                            setScore(score + 1);
                            statsByType[type] += 1;
                            item.remove();
                        }
                    });
                };
            });
    }

    function drawSummaryChart() {
        const data = [
            { name: "Rects", value: statsByType.rect, color: "#0984e3" },
            { name: "Circles", value: statsByType.circle, color: "#e84393" },
            { name: "Stars", value: statsByType.path, color: "#fdcb6e" }
        ];

        const container = d3.select("#chart-container");
        container.html("");

        const margin = { top: 10, right: 30, bottom: 30, left: 60 };
        const cWidth = 400 - margin.left - margin.right;
        const cHeight = 200 - margin.top - margin.bottom;

        const chartSvg = container.append("svg")
            .attr("width", cWidth + margin.left + margin.right)
            .attr("height", cHeight + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const maxVal = d3.max(data, d => d.value) ?? 0;

        const x = d3.scaleLinear()
            .domain([0, Math.max(maxVal, 5)])
            .range([0, cWidth]);

        const y = d3.scaleBand()
            .domain(data.map(d => d.name))
            .range([0, cHeight])
            .padding(0.2);

        chartSvg.append("g")
            .attr("transform", `translate(0,${cHeight})`)
            .call(d3.axisBottom(x).ticks(5));

        chartSvg.append("g").call(d3.axisLeft(y));

        const bars = chartSvg.selectAll("rect.bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", 0)
            .attr("y", d => y(d.name))
            .attr("height", y.bandwidth())
            .attr("fill", d => d.color)
            .attr("width", 0);

        bars.transition()
            .duration(900)
            .attr("width", d => x(d.value));

        chartSvg.selectAll("text.value")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "bar-value value")
            .attr("x", d => Math.max(10, x(d.value) - 6))
            .attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
            .attr("text-anchor", "end")
            .text(d => d.value ? d.value : "");

        d3.select("#results-text").html(`Total caught: <b>${score}</b> shapes.`);
    }

    document.getElementById("start-btn").addEventListener("click", startGame);
    document.getElementById("play-again-btn").addEventListener("click", () => {
        showSummary(false);
        showStartButton(true);
        document.getElementById("start-btn").textContent = "Play Again";
    });

    window.addEventListener("resize", () => location.reload());
</script>
</body>
</html>
